--SP_faultFinder v2.0 17/12/25
--fixed issue that logging to table was not working

--creates a table and stored procedure then use the below queries to see results\trends
------------------------------------
--Example procedure usage
--EXEC dbo.sp_FaultFinder @TopN = 10, @SortBy = 'CPU', @OutputMode = 'Summary';
--EXEC dbo.sp_FaultFinder @TopN = 5, @SortBy = 'Duration', @OutputMode = 'Detailed';
--EXEC dbo.sp_FaultFinder @TopN = 20, @SortBy = 'Reads', @Export = 1;
--Reporting
/*
-- Top queries by CPU over the last 7 days
SELECT TOP 20
    QueryText,
    DatabaseName,
    COUNT(*) AS SnapshotsCaptured,
    AVG(AvgCPU) AS AvgCPU,
    MAX(AvgCPU) AS PeakCPU,
    AVG(AvgDuration) AS AvgDuration,
    MAX(AvgDuration) AS PeakDuration,
    AVG(AvgReads) AS AvgReads,
    MAX(AvgReads) AS PeakReads,
    MIN(LogDate) AS FirstSeen,
    MAX(LogDate) AS LastSeen
FROM dbo.FaultFinderLog
WHERE LogDate >= DATEADD(DAY, -7, GETDATE())
GROUP BY QueryText, DatabaseName
ORDER BY AvgCPU DESC;

------------------------------------------------------------

-- Trend report: average duration per day for top queries
SELECT 
    CAST(LogDate AS DATE) AS LogDay,
    QueryText,
    DatabaseName,
    AVG(AvgDuration) AS AvgDurationPerDay,
    MAX(AvgDuration) AS PeakDurationPerDay
FROM dbo.FaultFinderLog
WHERE LogDate >= DATEADD(DAY, -7, GETDATE())
GROUP BY CAST(LogDate AS DATE), QueryText, DatabaseName
ORDER BY LogDay, AvgDurationPerDay DESC;

------------------------------------------------------------

-- Most frequently captured queries (appear in snapshots most often)
SELECT TOP 20
    QueryText,
    DatabaseName,
    COUNT(*) AS TimesCaptured,
    AVG(AvgCPU) AS AvgCPU,
    AVG(AvgDuration) AS AvgDuration
FROM dbo.FaultFinderLog
WHERE LogDate >= DATEADD(DAY, -30, GETDATE())
GROUP BY QueryText, DatabaseName
ORDER BY TimesCaptured DESC;
*/
-------------------------------------------------------------------------------------
-- Create a logging table if it doesn't exist

IF OBJECT_ID('dbo.FaultFinderLog', 'U') IS NULL
BEGIN
    CREATE TABLE dbo.FaultFinderLog (
        LogID INT IDENTITY(1,1) PRIMARY KEY,
        LogDate DATETIME NOT NULL DEFAULT GETDATE(),
        DatabaseName NVARCHAR(128),
        ExecutionCount BIGINT,
        CreationTime DATETIME,
        LastExecutionTime DATETIME,
        AvgCPU FLOAT,
        AvgDuration FLOAT,
        AvgReads FLOAT,
        AvgWrites FLOAT,
        TotalCPU BIGINT,
        TotalDuration BIGINT,
        TotalReads BIGINT,
        TotalWrites BIGINT,
        QueryText NVARCHAR(MAX),
        QueryPlanXML XML
    );
END
GO

IF OBJECT_ID('dbo.sp_FaultFinder', 'P') IS NOT NULL
    DROP PROCEDURE dbo.sp_FaultFinder;
GO

CREATE PROCEDURE dbo.sp_FaultFinder
    @TopN INT = 20,
    @SortBy NVARCHAR(20) = 'CPU',         -- CPU | Duration | Reads | Writes | Count
    @DatabaseName NVARCHAR(128) = NULL,
    @Keyword NVARCHAR(100) = NULL,
    @OutputMode NVARCHAR(20) = 'Summary', -- Summary | Detailed
    @Export BIT = 0
AS
BEGIN
    SET NOCOUNT ON;
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

    -- Validate @SortBy
    IF UPPER(@SortBy) NOT IN ('CPU','DURATION','READS','WRITES','COUNT')
    BEGIN
        RAISERROR('Invalid @SortBy. Use CPU, Duration, Reads, Writes, or Count.', 16, 1);
        RETURN;
    END

    BEGIN TRY
        ;WITH QueryStats AS (
            SELECT
                DB_NAME(st.dbid) AS DatabaseName,
                qs.execution_count AS ExecutionCount,
                qs.creation_time    AS CreationTime,
                qs.last_execution_time AS LastExecutionTime,
                qs.total_worker_time / NULLIF(qs.execution_count,0)  AS AvgCPU,
                qs.total_elapsed_time / NULLIF(qs.execution_count,0) AS AvgDuration,
                qs.total_logical_reads / NULLIF(qs.execution_count,0) AS AvgReads,
                qs.total_logical_writes / NULLIF(qs.execution_count,0) AS AvgWrites,
                qs.total_worker_time     AS TotalCPU,
                qs.total_elapsed_time    AS TotalDuration,
                qs.total_logical_reads   AS TotalReads,
                qs.total_logical_writes  AS TotalWrites,
                SUBSTRING(st.text, (qs.statement_start_offset/2)+1,
                    ((CASE qs.statement_end_offset
                        WHEN -1 THEN DATALENGTH(st.text)
                        ELSE qs.statement_end_offset END
                        - qs.statement_start_offset)/2)+1) AS QueryText,
                qp.query_plan AS QueryPlanXML
            FROM sys.dm_exec_query_stats qs
            CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) st
            CROSS APPLY sys.dm_exec_query_plan(qs.plan_handle) qp
        )
        SELECT TOP (@TopN)
            DatabaseName,
            ExecutionCount,
            CreationTime,
            LastExecutionTime,
            AvgCPU,
            AvgDuration,
            AvgReads,
            AvgWrites,
            TotalCPU,
            TotalDuration,
            TotalReads,
            TotalWrites,
            QueryText,
            CASE WHEN @OutputMode = 'Detailed' THEN QueryPlanXML ELSE NULL END AS QueryPlanXML
        INTO #Results
        FROM QueryStats
        WHERE (@DatabaseName IS NULL OR DatabaseName = @DatabaseName)
          AND (@Keyword IS NULL OR QueryText LIKE '%' + @Keyword + '%')
        ORDER BY
            CASE UPPER(@SortBy)
                WHEN 'CPU'      THEN AvgCPU
                WHEN 'DURATION' THEN AvgDuration
                WHEN 'READS'    THEN AvgReads
                WHEN 'WRITES'   THEN AvgWrites
                WHEN 'COUNT'    THEN ExecutionCount
            END DESC;

        -- Export results if requested and if we captured rows
        IF @Export = 1
        BEGIN
            IF EXISTS (SELECT 1 FROM #Results)
            BEGIN
                INSERT INTO dbo.FaultFinderLog (
                    DatabaseName, ExecutionCount, CreationTime, LastExecutionTime,
                    AvgCPU, AvgDuration, AvgReads, AvgWrites,
                    TotalCPU, TotalDuration, TotalReads, TotalWrites,
                    QueryText, QueryPlanXML
                )
                SELECT DatabaseName, ExecutionCount, CreationTime, LastExecutionTime,
                       AvgCPU, AvgDuration, AvgReads, AvgWrites,
                       TotalCPU, TotalDuration, TotalReads, TotalWrites,
                       QueryText, QueryPlanXML
                FROM #Results;
            END
        END

        -- Return results to caller
        SELECT * FROM #Results;

        DROP TABLE IF EXISTS #Results;
    END TRY
    BEGIN CATCH
        DECLARE @Err NVARCHAR(4000) = ERROR_MESSAGE();
        DECLARE @Num INT = ERROR_NUMBER();
        DECLARE @Sev INT = ERROR_SEVERITY();
        DECLARE @Sta INT = ERROR_STATE();
        DECLARE @Line INT = ERROR_LINE();
        RAISERROR('sp_FaultFinder failed (%d, sev %d, state %d) at line %d: %s', 16, 1, @Num, @Sev, @Sta, @Line, @Err);
        IF OBJECT_ID('tempdb..#Results') IS NOT NULL DROP TABLE #Results;
    END CATCH
END
GO
