--Agent job fails
--08/10/25
--Adrian Sleigh

SELECT
   SUBSTRING(j.name,1,50) AS JobName,
    h.step_id,
   SUBSTRING(h.step_name,1,40)AS step_name,
    h.run_date,
    h.run_time,
    h.run_duration,
    h.message AS ErrorMessage,
    CASE
        WHEN h.message LIKE '%Login failed%' THEN N'ğŸ”‘ Check SQL Agent service account permissions or credentials.'
        WHEN h.message LIKE '%could not find stored procedure%' THEN N'ğŸ“„ Verify the procedure exists and is accessible.'
        WHEN h.message LIKE '%timeout%' THEN N'â±ï¸ Investigate query performance or resource contention.'
        WHEN h.message LIKE '%network-related%' THEN N'ğŸŒ Check network connectivity and linked server configuration.'
        WHEN h.message LIKE '%Access is denied%' THEN N'ğŸ” Check file system or OS-level permissions.'
        WHEN h.message LIKE '%The process could not be created%' THEN N'âš™ï¸ Check job step command and executable path.'
        WHEN h.message LIKE '%Out of memory%' THEN N'ğŸ§  Review memory usage and consider increasing server resources.'
        WHEN h.message LIKE '%deadlock%' THEN N'ğŸ”„ Review transaction logic and indexing to reduce contention.'
        ELSE N'ğŸ› ï¸ Review the error message for specific troubleshooting steps.'
    END AS SuggestedFix
FROM msdb.dbo.sysjobhistory h
JOIN msdb.dbo.sysjobs j ON h.job_id = j.job_id
WHERE h.run_status = 0  -- Failed
ORDER BY h.run_date DESC, h.run_time DESC;
