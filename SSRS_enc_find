--find ssrs reports that have encrypted connections
--09/01/2025
/*
This script identifies:
Shared data sources
Embedded data sources
Any item where CredentialRetrieval = 2 (stored credentials)
Any item where credentials are now NULL due to key deletion
Any item referencing the unattended execution account
*/
---------------------------------------------------
USE ReportServer;
GO

WITH DataSources AS
(
    SELECT
        c.ItemID,
        c.Path,
        c.Name AS ItemName,
        c.Type,
        ds.DSID,
        ds.Name AS DataSourceName,
        ds.Extension,
        ds.ConnectionString,
        ds.CredentialRetrieval,
        ds.UserName
    FROM dbo.Catalog c
    LEFT JOIN dbo.DataSource ds
        ON c.ItemID = ds.ItemID
    WHERE c.Type IN (2, 5)  -- 2 = Report, 5 = Shared Data Source
)
SELECT
    CASE WHEN Type = 5 THEN 'Shared Data Source'
         WHEN Type = 2 THEN 'Report (Embedded DS)'
         ELSE 'Other'
    END AS DataSourceType,
    Path,
    DataSourceName,
    Extension,
    ConnectionString,
    CredentialRetrieval,
    UserName,
    CASE 
        WHEN CredentialRetrieval = 2 THEN 'Stored credentials (needs re-entry)'
        WHEN CredentialRetrieval = 4 THEN 'Unattended execution account (needs re-entry)'
        WHEN CredentialRetrieval IS NULL THEN 'Broken / missing credentials'
        ELSE 'OK'
    END AS Status
FROM DataSources
WHERE CredentialRetrieval IN (2, 4)  -- stored or unattended
   OR UserName IS NULL               -- missing due to key deletion
ORDER BY Path, DataSourceName;
